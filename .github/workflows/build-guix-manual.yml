name: Build Guix manual (PDF)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  manual:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (empty repo is fine)
        uses: actions/checkout@v4

      - name: Install toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y git texinfo \
            texlive-latex-base texlive-latex-recommended \
            texlive-fonts-recommended texlive-latex-extra \
            texlive-plain-generic

      - name: Fetch Guix sources (doc only)
        run: |
          git clone --depth=1 https://git.savannah.gnu.org/git/guix.git
          cd guix/doc
          # Minimal version.texi so we don't need ./configure
          cat > version.texi <<'EOF'
          @c Autogenerated by GitHub Actions
          @set EDITION snapshot
          @set VERSION snapshot
          @set UPDATED 2025-01-01
          @set UPDATED-MONTH Jan
          EOF

      - name: Build PDF with makeinfo
        working-directory: guix/doc
        run: |
          makeinfo --no-split --pdf -o guix-manual.pdf guix.texi

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: guix-manual-pdf
          path: guix/doc/guix-manual.pdf
